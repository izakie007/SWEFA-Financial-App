create table chapters (
  id uuid primary key default gen_random_uuid(),
  name text not null unique,
  created_at timestamptz default now()
);

create table roles (
  id smallint primary key,
  code text unique not null,
  description text
);

insert into roles (id, code, description) values
(1, 'CHAPTER_FS', 'Chapter Financial Secretary'),
(2, 'CHAPTER_TREASURER', 'Chapter Treasurer'),
(3, 'NATIONAL_FS', 'National Financial Secretary'),
(4, 'NATIONAL_TREASURER', 'National Treasurer'),
(9, 'ADMIN', 'System Administrator');

create table user_profiles (
  user_id uuid primary key references auth.users(id) on delete cascade,
  role_id smallint references roles(id),
  chapter_id uuid references chapters(id),
  is_active boolean default true,
  created_at timestamptz default now()
);

create table members (
  id uuid primary key default gen_random_uuid(),
  chapter_id uuid references chapters(id),
  full_name text not null,
  membership_number text,
  is_active boolean default true,
  created_at timestamptz default now()
);

create table purposes (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  level text check (level in ('CHAPTER', 'NATIONAL', 'BOTH')),
  expected_amount numeric(12,2),
  start_date date,
  end_date date,
  is_active boolean default true,
  created_at timestamptz default now()
);

create table member_transactions (
  id uuid primary key default gen_random_uuid(),
  chapter_id uuid references chapters(id),
  member_id uuid references members(id),
  purpose_id uuid references purposes(id),
  amount numeric(12,2) not null,
  transaction_type text check (transaction_type in ('COLLECTION', 'DISBURSEMENT')),
  destination text check (destination in ('CHAPTER', 'NATIONAL')),
  recorded_by uuid references auth.users(id),
  transaction_date date not null,
  created_at timestamptz default now(),
  locked boolean default false
);

create table fs_to_chapter_treasurer (
  id uuid primary key default gen_random_uuid(),
  chapter_id uuid references chapters(id),
  purpose_id uuid references purposes(id),
  amount numeric(12,2) not null,
  handed_over_by uuid references auth.users(id),
  handed_over_at timestamptz default now()
);

create table chapter_treasurer_receipts (
  id uuid primary key default gen_random_uuid(),
  chapter_id uuid references chapters(id),
  purpose_id uuid references purposes(id),
  amount_received numeric(12,2) not null,
  received_by uuid references auth.users(id),
  received_at timestamptz default now()
);

create table chapter_to_national_transfers (
  id uuid primary key default gen_random_uuid(),
  chapter_id uuid references chapters(id),
  purpose_id uuid references purposes(id),
  amount numeric(12,2) not null,
  sent_by uuid references auth.users(id),
  sent_at timestamptz default now()
);

create table national_fs_handover (
  id uuid primary key default gen_random_uuid(),
  purpose_id uuid references purposes(id),
  amount numeric(12,2) not null,
  handed_over_by uuid references auth.users(id),
  handed_over_at timestamptz default now()
);

create table national_treasurer_receipts (
  id uuid primary key default gen_random_uuid(),
  purpose_id uuid references purposes(id),
  amount_received numeric(12,2) not null,
  received_by uuid references auth.users(id),
  received_at timestamptz default now()
);

create table bank_transactions (
  id uuid primary key default gen_random_uuid(),
  level text check (level in ('CHAPTER', 'NATIONAL')),
  chapter_id uuid references chapters(id),
  purpose_id uuid references purposes(id),
  transaction_type text check (transaction_type in ('DEPOSIT', 'WITHDRAWAL')),
  amount numeric(12,2),
  performed_by uuid references auth.users(id),
  performed_at timestamptz default now()
);

create table audit_logs (
  id bigint generated always as identity primary key,
  user_id uuid,
  action text,
  table_name text,
  record_id uuid,
  old_data jsonb,
  new_data jsonb,
  created_at timestamptz default now()
);

alter table member_transactions enable row level security;

create or replace function current_user_role()
returns text language sql stable as $$
  select r.code
  from user_profiles up
  join roles r on r.id = up.role_id
  where up.user_id = auth.uid();
$$;

create policy "Chapter FS access"
on member_transactions
for all
using (
  chapter_id = (
    select chapter_id from user_profiles where user_id = auth.uid()
  )
  and current_user_role() = 'CHAPTER_FS'
);

create policy "Chapter Treasurer read"
on member_transactions
for select
using (
  chapter_id = (
    select chapter_id from user_profiles where user_id = auth.uid()
  )
  and current_user_role() = 'CHAPTER_TREASURER'
);

create policy "National FS national view"
on member_transactions
for select
using (
  destination = 'NATIONAL'
  and current_user_role() = 'NATIONAL_FS'
);

create policy "FS insert handover"
on fs_to_chapter_treasurer
for insert
with check (
  current_user_role() = 'CHAPTER_FS'
);

create policy "Treasurer read handover"
on fs_to_chapter_treasurer
for select
using (
  current_user_role() = 'CHAPTER_TREASURER'
);

create policy "National FS insert handover"
on national_fs_handover
for insert
with check (
  current_user_role() = 'NATIONAL_FS'
);

create policy "National Treasurer read handover"
on national_fs_handover
for select
using (
  current_user_role() = 'NATIONAL_TREASURER'
);

-- Current user's role
create or replace function user_role()
returns text
language sql
stable
as $$
  select r.code
  from user_profiles up
  join roles r on r.id = up.role_id
  where up.user_id = auth.uid();
$$;

-- Current user's chapter
create or replace function user_chapter()
returns uuid
language sql
stable
as $$
  select chapter_id
  from user_profiles
  where user_id = auth.uid();
$$;

-- Current active financial year
create or replace function current_financial_year()
returns uuid
language sql
stable
as $$
  select id from financial_years where is_active = true;
$$;

alter table chapters enable row level security;

create policy chapters_read_all
on chapters
for select
using (true);

alter table roles enable row level security;

create policy roles_read_all
on roles
for select
using (true);

alter table user_profiles enable row level security;

-- Users can read their own profile
create policy profile_read_self
on user_profiles
for select
using (user_id = auth.uid());

-- Admin can read all
create policy profile_admin_read
on user_profiles
for select
using (user_role() = 'ADMIN');

alter table members enable row level security;

-- Chapter FS read members
create policy members_fs_read
on members
for select
using (
  user_role() = 'CHAPTER_FS'
  and chapter_id = user_chapter()
);

-- Chapter FS insert
create policy members_fs_insert
on members
for insert
with check (
  user_role() = 'CHAPTER_FS'
  and chapter_id = user_chapter()
);

-- Chapter FS update
create policy members_fs_update
on members
for update
using (
  user_role() = 'CHAPTER_FS'
  and chapter_id = user_chapter()
);

alter table purposes enable row level security;

-- Everyone can read purposes
create policy purposes_read_all
on purposes
for select
using (true);

-- Admin only can write
create policy purposes_admin_write
on purposes
for all
using (user_role() = 'ADMIN')
with check (user_role() = 'ADMIN');

alter table member_transactions enable row level security;

-- No updates or deletes allowed (immutable)

alter table fs_to_chapter_treasurer enable row level security;

-- FS insert
create policy fs_ct_insert
on fs_to_chapter_treasurer
for insert
with check (
  user_role() = 'CHAPTER_FS'
  and chapter_id = user_chapter()
  and financial_year_id = current_financial_year()
);

-- Treasurer read
create policy fs_ct_treasurer_read
on fs_to_chapter_treasurer
for select
using (
  user_role() = 'CHAPTER_TREASURER'
  and chapter_id = user_chapter()
);

-- National FS read
create policy fs_ct_national_read
on fs_to_chapter_treasurer
for select
using (user_role() = 'NATIONAL_FS');

alter table chapter_treasurer_receipts enable row level security;

-- Treasurer insert
create policy ctr_insert
on chapter_treasurer_receipts
for insert
with check (
  user_role() = 'CHAPTER_TREASURER'
  and chapter_id = user_chapter()
  and financial_year_id = current_financial_year()
);

-- FS read
create policy ctr_fs_read
on chapter_treasurer_receipts
for select
using (
  user_role() = 'CHAPTER_FS'
  and chapter_id = user_chapter()
);

-- National FS read
create policy ctr_national_read
on chapter_treasurer_receipts
for select
using (user_role() = 'NATIONAL_FS');

alter table chapter_to_national_transfers enable row level security;

-- Chapter Treasurer insert
create policy cnt_insert
on chapter_to_national_transfers
for insert
with check (
  user_role() = 'CHAPTER_TREASURER'
  and chapter_id = user_chapter()
  and financial_year_id = current_financial_year()
);

-- National FS read
create policy cnt_national_fs_read
on chapter_to_national_transfers
for select
using (user_role() = 'NATIONAL_FS');

-- National Treasurer read
create policy cnt_national_treasurer_read
on chapter_to_national_transfers
for select
using (user_role() = 'NATIONAL_TREASURER');

alter table national_fs_handover enable row level security;

-- National FS insert
create policy nfs_insert
on national_fs_handover
for insert
with check (
  user_role() = 'NATIONAL_FS'
  and financial_year_id = current_financial_year()
);

-- National Treasurer read
create policy nfs_treasurer_read
on national_fs_handover
for select
using (user_role() = 'NATIONAL_TREASURER');

alter table national_treasurer_receipts enable row level security;

-- National Treasurer insert
create policy ntr_insert
on national_treasurer_receipts
for insert
with check (
  user_role() = 'NATIONAL_TREASURER'
  and financial_year_id = current_financial_year()
);

-- National FS read
create policy ntr_fs_read
on national_treasurer_receipts
for select
using (user_role() = 'NATIONAL_FS');

alter table bank_transactions enable row level security;

-- Chapter Treasurer bank ops
create policy bank_chapter_treasurer
on bank_transactions
for all
using (
  user_role() = 'CHAPTER_TREASURER'
  and level = 'CHAPTER'
  and chapter_id = user_chapter()
)
with check (
  user_role() = 'CHAPTER_TREASURER'
  and level = 'CHAPTER'
  and chapter_id = user_chapter()
);

-- National Treasurer bank ops
create policy bank_national_treasurer
on bank_transactions
for all
using (
  user_role() = 'NATIONAL_TREASURER'
  and level = 'NATIONAL'
)
with check (
  user_role() = 'NATIONAL_TREASURER'
  and level = 'NATIONAL'
);

alter table financial_years enable row level security;

-- Everyone read
create policy fy_read
on financial_years
for select
using (true);

-- Admin manage
create policy fy_admin_manage
on financial_years
for all
using (user_role() = 'ADMIN')
with check (user_role() = 'ADMIN');

alter table audit_logs enable row level security;

-- Admin only
create policy audit_admin_read
on audit_logs
for select
using (user_role() = 'ADMIN');

alter table member_transactions
add column correction_of uuid references member_transactions(id),
add column correction_reason text;

create or replace function enforce_counter_entry()
returns trigger
language plpgsql
as $$
declare
  original record;
begin
  if new.correction_of is not null then
    select * into original
    from member_transactions
    where id = new.correction_of;

    if original.amount + new.amount != 0 then
      raise exception 'Correction must fully offset original transaction';
    end if;
  end if;

  return new;
end;
$$;

create trigger trg_counter_entry
before insert on member_transactions
for each row
execute function enforce_counter_entry();

create view v_chapter_purpose_summary as
select
  mt.chapter_id,
  mt.purpose_id,
  p.name as purpose_name,
  p.expected_amount,
  count(distinct mt.member_id) as contributors,
  sum(mt.amount) as total_collected,
  (p.expected_amount * count(distinct m.id)) as total_expected,
  ((p.expected_amount * count(distinct m.id)) - sum(mt.amount)) as balance_remaining
from member_transactions mt
join purposes p on p.id = mt.purpose_id
join members m on m.chapter_id = mt.chapter_id
where mt.transaction_type = 'COLLECTION'
group by mt.chapter_id, mt.purpose_id, p.name, p.expected_amount;

create view v_members_pending_contributions as
select
  m.id as member_id,
  m.full_name,
  m.chapter_id,
  p.id as purpose_id,
  p.name as purpose_name,
  coalesce(sum(mt.amount), 0) as amount_paid,
  p.expected_amount,
  (p.expected_amount - coalesce(sum(mt.amount), 0)) as balance
from members m
cross join purposes p
left join member_transactions mt
  on mt.member_id = m.id
  and mt.purpose_id = p.id
  and mt.transaction_type = 'COLLECTION'
group by m.id, m.full_name, m.chapter_id, p.id, p.name, p.expected_amount
having (p.expected_amount - coalesce(sum(mt.amount), 0)) > 0;

create view v_chapter_reconciliation as
select
  fs.chapter_id,
  fs.purpose_id,
  p.name as purpose_name,
  sum(fs.amount) as fs_handed_over,
  coalesce(sum(tr.amount_received), 0) as treasurer_received,
  (sum(fs.amount) - coalesce(sum(tr.amount_received), 0)) as difference
from fs_to_chapter_treasurer fs
join purposes p on p.id = fs.purpose_id
left join chapter_treasurer_receipts tr
  on tr.chapter_id = fs.chapter_id
  and tr.purpose_id = fs.purpose_id
group by fs.chapter_id, fs.purpose_id, p.name;

create view v_national_summary as
select
  mt.chapter_id,
  c.name as chapter_name,
  mt.purpose_id,
  p.name as purpose_name,
  sum(mt.amount) as total_amount,
  count(distinct mt.member_id) as contributors,
  count(distinct case when mt.amount < p.expected_amount then mt.member_id end) as incomplete_contributors
from member_transactions mt
join chapters c on c.id = mt.chapter_id
join purposes p on p.id = mt.purpose_id
where mt.destination = 'NATIONAL'
group by mt.chapter_id, c.name, mt.purpose_id, p.name;

create or replace function lock_purpose_transactions(p_purpose_id uuid)
returns void
language plpgsql
security definer
as $$
begin
  update member_transactions
  set locked = true
  where purpose_id = p_purpose_id;
end;
$$;

create or replace function get_chapter_balance_status()
returns table (
  chapter_id uuid,
  chapter_name text,
  balanced boolean
)
language sql
security definer
as $$
select
  c.id,
  c.name,
  sum(r.difference) = 0 as balanced
from v_chapter_reconciliation r
join chapters c on c.id = r.chapter_id
group by c.id, c.name;
$$;

create or replace function national_reconciliation()
returns table (
  purpose_id uuid,
  purpose_name text,
  expected numeric,
  received numeric,
  difference numeric
)
language sql
security definer
as $$
select
  p.id,
  p.name,
  coalesce(sum(nfs.amount), 0) as expected,
  coalesce(sum(ntr.amount_received), 0) as received,
  (coalesce(sum(nfs.amount), 0) - coalesce(sum(ntr.amount_received), 0)) as difference
from national_fs_handover nfs
join purposes p on p.id = nfs.purpose_id
left join national_treasurer_receipts ntr
  on ntr.purpose_id = p.id
group by p.id, p.name;
$$;

create or replace function audit_trigger()
returns trigger
language plpgsql
as $$
begin
  insert into audit_logs(user_id, action, table_name, record_id, old_data, new_data)
  values (auth.uid(), TG_OP, TG_TABLE_NAME, old.id, to_jsonb(old), to_jsonb(new));
  return new;
end;
$$;

create trigger audit_member_transactions
after update or delete
on member_transactions
for each row
execute function audit_trigger();

create or replace function user_role()
returns text language sql stable as $$
  select r.code
  from user_profiles up
  join roles r on r.id = up.role_id
  where up.user_id = auth.uid();
$$;

create or replace function user_chapter()
returns uuid language sql stable as $$
  select chapter_id
  from user_profiles
  where user_id = auth.uid();
$$;

alter table member_transactions enable row level security;

create policy mt_fs_insert
on member_transactions
for insert
with check (
  user_role() = 'CHAPTER_FS'
  and chapter_id = user_chapter()
  and locked = false
);

create policy mt_fs_read
on member_transactions
for select
using (
  user_role() = 'CHAPTER_FS'
  and chapter_id = user_chapter()
);

create policy mt_treasurer_read
on member_transactions
for select
using (
  user_role() = 'CHAPTER_TREASURER'
  and chapter_id = user_chapter()
);

create policy mt_national_fs_read
on member_transactions
for select
using (
  user_role() = 'NATIONAL_FS'
  and destination = 'NATIONAL'
);

create policy mt_no_update_when_locked
on member_transactions
for update
using (locked = false);

create table financial_years (
  id uuid primary key default gen_random_uuid(),
  year_label text not null unique, -- e.g. "2025"
  start_date date not null,
  end_date date not null,
  is_active boolean default false,
  is_closed boolean default false,
  created_at timestamptz default now()
);

alter table member_transactions
add column financial_year_id uuid references financial_years(id);

alter table fs_to_chapter_treasurer
add column financial_year_id uuid references financial_years(id);

alter table chapter_treasurer_receipts
add column financial_year_id uuid references financial_years(id);

alter table chapter_to_national_transfers
add column financial_year_id uuid references financial_years(id);

alter table national_fs_handover
add column financial_year_id uuid references financial_years(id);

alter table national_treasurer_receipts
add column financial_year_id uuid references financial_years(id);

create or replace function current_financial_year()
returns uuid language sql stable as $$
  select id from financial_years where is_active = true;
$$;

alter table member_transactions
alter column financial_year_id
set default current_financial_year();

create or replace function can_close_financial_year(p_year_id uuid)
returns boolean
language sql
security definer
as $$
select not exists (
  select 1
  from v_chapter_reconciliation
  where difference != 0
);
$$;

create or replace function close_financial_year(p_year_id uuid)
returns void
language plpgsql
security definer
as $$
begin
  if not can_close_financial_year(p_year_id) then
    raise exception 'Cannot close year: unbalanced accounts exist';
  end if;

  update financial_years
  set is_active = false,
      is_closed = true
  where id = p_year_id;
end;
$$;

create or replace function open_new_financial_year(
  p_label text,
  p_start date,
  p_end date
)
returns void
language plpgsql
security definer
as $$
begin
  update financial_years set is_active = false;

  insert into financial_years (
    year_label, start_date, end_date, is_active
  )
  values (p_label, p_start, p_end, true);
end;
$$;

create view v_current_member_transactions as
select *
from member_transactions
where financial_year_id = current_financial_year();

create view v_archived_member_transactions as
select
  fy.year_label,
  mt.*
from member_transactions mt
join financial_years fy on fy.id = mt.financial_year_id
where fy.is_closed = true;

create policy no_insert_closed_year
on member_transactions
for insert
with check (
  financial_year_id = current_financial_year()
);

